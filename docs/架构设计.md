# Kong网关DNS服务发现系统架构设计文档

## 1. 引言

### 1.1. 目的
本文档旨在详细描述Kong网关DNS服务发现系统的整体架构设计，包括系统组件、组件间的交互、数据流、部署策略以及关键技术选型，为系统的开发、部署和维护提供指导。

### 1.2. 范围
本文档覆盖系统的核心功能模块、API服务、前端界面、数据存储以及相关的非功能性需求实现思路。

### 1.3. 参考资料
- 《Kong网关DNS服务发现系统需求文档》(./需求文档.md)

## 2. 架构概述

### 2.1. 核心思想
系统采用微服务架构，围绕DNS协议实现动态服务发现。核心思想包括：
- **端口分离**: 不同功能的API和服务通过独立端口提供，增强安全性与管理清晰度。
- **高可用性**: 支持多副本部署，确保核心服务在部分节点故障时仍能正常运行。
- **可扩展性**: 系统设计支持水平扩展，以应对不断增长的服务实例和查询负载。
- **配置驱动**: 关键参数通过配置管理，方便部署和调整。
- **etcd中心化存储**: 利用etcd作为服务注册信息、DNS记录和配置的统一存储，保证数据一致性和可靠性。

### 2.2. 系统架构图 (逻辑视图)

```mermaid
graph TD
    subgraph "用户/客户端"
        Admin[系统管理员/运维人员]
        Dev[开发人员/服务实例]
        Kong[Kong网关实例]
    end

    subgraph "服务发现系统"
        LB_API[API负载均衡器] --> RegAPI[服务注册API (Go, :8080)]
        LB_API --> AdminAPI[管理API (Go, :9090)]

        LB_DNS[DNS负载均衡器] --> DNSService[DNS服务 (Go, :53 UDP/TCP)]

        AdminUI[前端管理界面 (React, Vite, :3000)]

        RegAPI --> ETCD[(etcd集群)]
        AdminAPI --> ETCD
        DNSService --> ETCD

        GoSDK[Go SDK]
        ReactSDK[React SDK]
    end

    Dev -- "服务注册/注销/心跳 (Go SDK)" --> LB_API
    Admin -- "Web界面操作 (React SDK)" --> AdminUI
    AdminUI -- "API请求" --> LB_API
    Kong -- "DNS查询" --> LB_DNS
    Dev -- "直接API调用 (可选)" --> LB_API

    classDef api fill:#lightgreen,stroke:#333,stroke-width:2px;
    classDef ui fill:#lightblue,stroke:#333,stroke-width:2px;
    classDef dns fill:#orange,stroke:#333,stroke-width:2px;
    classDef db fill:#pink,stroke:#333,stroke-width:2px;
    classDef sdk fill:#cyan,stroke:#333,stroke-width:2px;

    class RegAPI,AdminAPI,DNSService api;
    class AdminUI ui;
    class DNSService dns;
    class ETCD db;
    class GoSDK,ReactSDK sdk;
```

## 3. 组件设计

### 3.1. 服务注册API服务 (Registration API Service)
- **职责**: 处理服务实例的注册、注销和心跳请求。
- **端口**: 8080 (TCP)
- **技术**: Go
- **交互**:
    - 接收来自服务实例（通过Go SDK或直接API调用）的请求。
    - 将服务信息（名称、IP、端口、命名空间、元数据、TTL等）写入etcd。
    - 更新服务心跳时间。
    - 在服务注册/注销时，触发相应的DNS记录更新逻辑。
- **关键点**: 接口需保持轻量和高效，支持高并发注册。

### 3.2. 管理API服务 (Admin API Service)
- **职责**: 提供系统管理功能，包括服务查询、命名空间管理、自定义DNS记录管理、系统状态查看和配置管理。
- **端口**: 9090 (TCP)
- **技术**: Go
- **交互**:
    - 接收来自前端管理界面（通过React SDK）或管理员直接API调用的请求。
    - 从etcd读取和写入管理数据（服务列表、命名空间、自定义DNS记录、系统配置）。
- **关键点**: 提供丰富的查询和管理接口，支持细粒度权限控制（未来）。

### 3.3. DNS服务模块 (DNS Service Module)
- **职责**: 响应DNS查询请求，将服务名解析为IP地址（A记录）或服务地址及端口（SRV记录）。
- **端口**: 53 (UDP/TCP)
- **技术**: Go
- **交互**:
    - 接收来自Kong网关或其他DNS客户端的查询。
    - 从etcd读取服务注册信息和自定义DNS记录。
    - 实现DNS记录的动态生成、负载均衡（轮询）、命名空间解析。
    - 对未匹配的域名，转发到上游DNS服务器。
    - 支持DNS缓存以提高性能。
- **关键点**: 高性能、低延迟、符合DNS协议标准。

### 3.4. 前端管理界面 (Admin UI)
- **职责**: 提供图形化界面，方便管理员监控服务状态、管理命名空间、配置自定义DNS记录和系统参数。
- **端口**: 3000 (TCP)
- **技术**: React, Vite, TypeScript, Tailwind CSS
- **交互**:
    - 通过React SDK与管理API服务（端口9090）交互。
- **关键点**: 用户友好、信息直观、响应迅速。

### 3.5. 数据存储 (etcd)
- **职责**: 持久化存储服务注册信息、健康状态、自定义DNS记录、命名空间配置和系统配置。
- **技术**: etcd 3.5+
- **选型理由**:
    - 分布式键值存储，提供强一致性。
    - 支持Watch机制，便于服务动态感知数据变化。
    - 社区成熟，被广泛应用于服务发现场景。
- **数据模型**: 参见《需求文档.md》中的服务实体、DNS记录实体、命名空间实体。
- **部署**: 推荐集群部署以保证高可用性。

### 3.6. Go SDK
- **职责**: 封装服务注册API的调用逻辑，简化服务实例接入服务发现系统的复杂度。
- **功能**: 服务注册、注销、心跳维持、自动重连、错误处理。
- **目标**: 供后端Go服务集成。

### 3.7. React SDK (UI组件库)
- **职责**: 封装管理API的调用逻辑，提供可复用的React组件供前端管理界面使用。
- **功能**: 服务列表、服务详情、配置管理等组件。
- **目标**: 供前端管理界面（Admin UI）使用。

## 4. 接口设计

### 4.1. API风格
- 所有HTTP API均遵循RESTful设计规范。
- 使用JSON作为数据交换格式。

### 4.2. 端口分离
- **服务注册API**: 8080 (TCP) - 服务实例交互
- **管理API**: 9090 (TCP) - 管理界面和运维监控
- **DNS服务**: 53 (UDP/TCP) - DNS解析
- **前端界面**: 3000 (TCP) - React管理界面

### 4.3. 认证与授权 (未来规划)
- **API Token认证**: _(未来规划)_ 计划为所有API（8080, 9090）将采用基于Token的认证机制。
- **RBAC (未来)**: _(未来规划)_ 计划支持基于角色的访问控制，对管理API进行更细粒度的权限管理。

## 5. 数据流

### 5.1. 服务注册流程
1. 服务实例（通过Go SDK）向服务注册API (8080) 发起注册请求，包含服务名、IP、端口、命名空间等信息。
2. 服务注册API校验请求数据。
3. 服务注册API将服务信息写入etcd，并设置TTL。
4. 服务注册API触发DNS记录生成逻辑，将对应的A/SRV记录信息写入etcd或直接由DNS服务模块感知。
5. 服务实例定期发送心跳到服务注册API，刷新TTL。

### 5.2. DNS解析流程
1. DNS客户端（如Kong网关）向DNS服务 (53) 发起域名查询请求。
2. DNS服务模块首先查询自定义DNS记录。
3. 若无自定义记录，则根据服务名和命名空间从etcd查询对应的服务实例信息。
4. DNS服务模块根据查询类型（A/SRV）和负载均衡策略，从健康的服务实例中选择一个或多个IP/端口。
5. DNS服务模块构造DNS响应报文返回给客户端。
6. 若服务不存在且配置了上游DNS，则将请求转发给上游DNS。

### 5.3. 心跳超时与清理流程
1. 后台任务（可集成在服务注册API或独立调度）定期扫描etcd中的服务实例。
2. 对于心跳时间超过预设阈值（TTL失效）的服务实例，判定为不健康。
3. 系统自动从etcd中删除不健康的服务实例信息。
4. 关联的DNS记录也随之被清理或失效。

## 6. 部署架构

### 6.1. 容器化
- 所有后端服务（服务注册API、管理API、DNS服务）和前端界面都将容器化（Docker）。
- 提供Dockerfile。

### 6.2. 编排
- **开发/测试环境**: 使用Docker Compose进行快速部署和管理。
- **生产环境**: 推荐使用Kubernetes进行编排，以实现自动扩缩容、故障自愈和滚动更新。

### 6.3. 多副本与高可用
- **核心服务 (服务注册API, 管理API, DNS服务)**: 支持部署多个副本，通过负载均衡器分发请求，实现高可用。
- **etcd**: 必须以集群模式部署 (至少3个节点)。
- **前端界面**: 可部署多副本，通过负载均衡访问。

### 6.4. 网络配置
- 根据需求文档中的防火墙建议配置网络访问策略，确保各端口按需开放。
- 内部组件通信在同一网络（如Docker bridge network或Kubernetes CNI）。

## 7. 非功能性考虑

### 7.1. 性能
- DNS查询: 严格控制在100ms以内 (95th percentile)。
- API响应: 控制在500ms以内 (95th percentile)。
- 通过缓存（DNS记录缓存、etcd watch机制减少直接查询）、高效的Go代码、优化的etcd查询实现。

### 7.2. 可用性
- 系统整体可用性目标99.9%。
- 通过多副本部署、etcd集群、自动故障切换（Kubernetes能力）实现。

### 7.3. 可扩展性
- DNS服务、API服务均设计为无状态或状态通过etcd共享，支持水平扩展。

### 7.4. 安全性
- API Token认证。
- HTTPS/TLS加密通信。
- 严格的端口访问控制。
- 定期安全审计和依赖库更新。

## 8. 技术选型总结
- **后端**: Go 1.21+
- **前端**: React 18+, Vite, TypeScript, Tailwind CSS
- **数据存储**: etcd 3.5+
- **容器化**: Docker
- **编排**: Docker Compose (dev), Kubernetes (prod recommended)
- **API网关集成**: Kong 