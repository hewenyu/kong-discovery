# Kong网关DNS服务发现系统需求文档

## 文档修订说明

**修订版本**: 1.2
**修订日期**: 2025-06-15
**主要更新内容**:

1. **端口分离设计**:
   - 服务注册端口: 8080 (TCP) - 供服务实例注册、注销、心跳使用
   - 管理端口: 9090 (TCP) - 供管理界面和运维监控使用
   - DNS服务端口: 53 (UDP/TCP) - 对外提供DNS解析服务
   - 前端界面端口: 3000 (TCP) - React管理界面

2. **安全策略支持**:
   - 各端口的防火墙配置建议
   - 细粒度访问控制

3. **API端点分离**:
   - 服务注册API (端口8080)
   - 管理API (端口9090)

4. **SDK配置更新**:
   - Go SDK默认连接注册端口(8080)
   - React前端连接管理端口(9090)
   - 新增前端SDK功能需求

5. **命名空间功能**:
   - 支持按命名空间隔离服务
   - DNS解析支持命名空间前缀
   - SDK支持命名空间配置

## 1. 项目背景与目标

### 1.1 项目背景
为了实现Kong网关的服务发现功能，需要开发一个基于DNS的服务发现系统。该系统将提供自动化的服务注册、健康检查、DNS解析等功能，以支持微服务架构下的动态服务发现需求。

### 1.2 项目目标
- 实现基于DNS协议的服务发现机制
- 提供自动化的服务注册和注销功能
- 支持服务健康检查和故障自动清理
- 提供Web管理界面用于服务监控和配置管理
- 确保系统的高可用性和可扩展性

### 1.3 目标用户
- **系统管理员**: 使用Web界面监控和管理服务
- **开发人员**: 使用SDK集成服务注册功能
- **运维人员**: 负责系统部署和维护

## 2. 系统功能需求

### 2.1 核心功能需求

#### 2.1.1 服务注册功能 (FR-001)
**优先级**: 高
**描述**: 支持服务实例的自动注册和手动注册

**详细需求**:
- 服务启动时自动向系统注册服务信息
- 支持注册服务名称、IP地址、端口号、标签等信息
- 支持自定义元数据信息
- 支持指定命名空间，默认为"default"
- 注册成功后返回唯一的服务ID
- 支持批量注册多个服务实例

**验收标准**:
- [ ] 提供RESTful API接口用于服务注册
- [ ] 注册信息能够正确存储到etcd中
- [ ] 注册后能够生成对应的DNS记录
- [ ] 支持重复注册同一服务的多个实例
- [ ] 支持在不同命名空间注册同名服务

#### 2.1.2 服务注销功能 (FR-002)
**优先级**: 高
**描述**: 支持服务实例的主动注销和自动注销

**详细需求**:
- 服务关闭时主动调用注销接口
- 支持通过服务ID进行注销
- 注销时清理相关的DNS记录
- 注销时清理etcd中的服务信息

**验收标准**:
- [ ] 提供RESTful API接口用于服务注销
- [ ] 注销后能够从etcd中删除服务信息
- [ ] 注销后能够清理对应的DNS记录
- [ ] 支持批量注销服务实例

#### 2.1.3 DNS解析功能 (FR-003)
**优先级**: 高
**描述**: 基于注册的服务信息提供DNS解析服务

**详细需求**:
- 支持A记录解析，将服务名解析为IP地址
- 支持SRV记录解析，提供服务端口信息
- 支持负载均衡，多个实例轮询返回
- 支持命名空间前缀解析，格式为"service.namespace.domain"
- 对于未注册的域名，转发到上游DNS服务器
- 支持DNS缓存以提高查询性能

**验收标准**:
- [ ] 能够正确解析已注册服务的域名
- [ ] 支持标准DNS协议(UDP 53端口)
- [ ] 支持命名空间前缀的DNS解析
- [ ] 未注册域名能够转发到上游DNS
- [ ] 多实例服务能够实现负载均衡
- [ ] DNS查询响应时间小于100ms

#### 2.1.4 心跳检测功能 (FR-004)
**优先级**: 高
**描述**: 监控服务实例的健康状态

**详细需求**:
- 服务实例定期发送心跳信号
- 系统检测心跳超时的服务实例
- 自动清理超时的服务实例和DNS记录
- 支持可配置的心跳间隔和超时时间
- 提供服务健康状态查询接口

**验收标准**:
- [ ] 服务实例能够定期发送心跳
- [ ] 系统能够检测心跳超时
- [ ] 超时服务能够自动清理
- [ ] 心跳间隔可配置(默认30秒)
- [ ] 超时时间可配置(默认90秒)

#### 2.1.5 配置管理功能 (FR-005)
**优先级**: 中
**描述**: 管理系统运行参数和DNS配置

**详细需求**:
- 配置上游DNS服务器地址
- 配置DNS缓存TTL时间
- 配置服务域名后缀
- 配置心跳检测参数
- 支持配置的动态更新

**验收标准**:
- [ ] 提供配置管理API接口
- [ ] 配置能够持久化存储
- [ ] 配置更新后立即生效
- [ ] 支持配置的导入和导出

#### 2.1.6 命名空间管理功能 (FR-011)
**优先级**: 高
**描述**: 支持服务的命名空间隔离

**详细需求**:
- 支持创建、更新、删除命名空间
- 支持在特定命名空间内注册服务
- 支持按命名空间查询服务列表
- 支持命名空间级别的访问控制
- 命名空间间的服务相互隔离

**验收标准**:
- [ ] 提供命名空间管理API接口
- [ ] 服务注册时支持指定命名空间
- [ ] DNS查询支持命名空间前缀
- [ ] 不同命名空间可以注册同名服务
- [ ] 管理界面支持命名空间视图切换

### 2.2 管理界面功能需求

#### 2.2.1 服务监控功能 (FR-006)
**优先级**: 中
**描述**: 通过Web界面监控服务状态

**详细需求**:
- 显示所有注册服务的列表
- 显示服务的详细信息(IP、端口、状态等)
- 显示服务关联的DNS记录 (例如A记录, SRV记录，只读)
- 显示服务的健康状态
- 支持服务搜索和过滤
- 实时更新服务状态

**验收标准**:
- [ ] 提供直观的服务列表界面
- [ ] 服务状态能够实时刷新
- [ ] 能够清晰展示各服务自动生成的DNS记录信息
- [ ] 支持按服务名、状态等条件过滤
- [ ] 界面响应时间小于2秒

#### 2.2.2 系统监控功能 (FR-007)
**优先级**: 中
**描述**: 显示系统整体运行状态

**详细需求**:
- 显示系统状态概览
- 显示服务注册统计信息
- 显示DNS查询统计信息
- 显示系统资源使用情况
- 提供告警信息展示

**验收标准**:
- [ ] 提供系统状态仪表板
- [ ] 统计数据准确无误
- [ ] 支持数据的图表展示
- [ ] 告警信息及时显示

#### 2.2.3 DNS配置管理功能 (FR-008)
**优先级**: 中
**描述**: 通过Web界面管理DNS配置**和自定义DNS记录**

**详细需求**:
- 配置上游DNS服务器
- **管理自定义DNS记录 (支持A, AAAA, CNAME, SRV等记录类型的增删改查)**
- 配置DNS缓存参数
- 查看DNS查询日志

**验收标准**:
- [ ] 提供DNS配置表单界面
- [ ] 配置保存后立即生效
- [ ] 支持自定义DNS记录的增删改查
- [ ] 配置验证和错误提示

### 2.3 SDK功能需求

#### 2.3.1 客户端SDK功能 (FR-009)
**优先级**: 高
**描述**: 提供Go语言SDK供服务集成使用

**详细需求**:
- 提供服务注册接口
- 提供服务注销接口
- 提供心跳维持接口
- 支持自动重连和错误重试
- 提供配置选项
- 默认连接注册端口(8080)
- 支持自定义配置

**验收标准**:
- [ ] SDK API接口简洁易用
- [ ] 支持同步和异步调用
- [ ] 提供完整的错误处理
- [ ] 包含详细的使用文档
- [ ] 提供示例代码

**配置示例**:
```go
// Go SDK配置示例
config := &discovery.Config{
    ServerAddr:     "dns-discovery.example.com:8080",  // 默认连接注册端口
    ServiceName:    "my-service",
    Namespace:      "production",                     // 指定命名空间
    ServicePort:    8080,
    Tags:           []string{"api", "v1"},
    HeartbeatInterval: 30 * time.Second,
    Timeout:        5 * time.Second,
    RetryCount:     3,
    Secure:         true,  // 启用HTTPS
    ApiToken:       "service-token-123",
}

client := discovery.NewClient(config)
```

#### 2.3.2 前端SDK功能 (FR-010)
**优先级**: 中
**描述**: 提供React组件库供前端管理界面使用

**详细需求**:
- 提供服务列表组件
- 提供服务详情组件
- 提供系统状态组件
- 提供配置管理组件
- 默认连接管理端口(9090)
- 支持自定义配置

**验收标准**:
- [ ] 组件接口简洁易用
- [ ] 支持自定义样式
- [ ] 提供完整的错误处理
- [ ] 包含详细的使用文档
- [ ] 提供示例代码

**配置示例**:
```jsx
// React前端配置示例
import { ServiceDiscoveryProvider } from 'kong-discovery-ui';

function App() {
  return (
    <ServiceDiscoveryProvider 
      apiEndpoint="http://dns-discovery.example.com:9090"
      defaultNamespace="production"
      authToken="admin-token-456"
      refreshInterval={5000}
    >
      <AdminDashboard />
    </ServiceDiscoveryProvider>
  );
}
```

## 3. 非功能性需求

### 3.1 性能需求 (NFR-001)
- DNS查询响应时间: < 100ms (95%的请求)
- API接口响应时间: < 500ms (95%的请求)
- 支持并发DNS查询: > 1000 QPS
- 支持并发API请求: > 500 RPS
- 系统启动时间: < 30秒

### 3.2 可用性需求 (NFR-002)
- 系统可用性: 99.9%
- 支持7x24小时运行
- **支持多副本部署，确保单点故障不影响整体服务**
- 故障恢复时间: < 5分钟
- 数据备份: 每日自动备份
- 支持灾难恢复

### 3.3 可扩展性需求 (NFR-003)
- 支持水平扩展DNS服务实例 **(支持多副本部署以提高可用性和吞吐量)**
- 支持etcd集群部署
- 支持服务实例数: > 10000个
- 支持DNS记录数: > 50000条
- 支持多机房部署

### 3.4 安全性需求 (NFR-004)
- API接口需要身份认证
- 支持HTTPS/TLS加密通信
- 管理界面需要登录验证
- 支持访问日志记录
- 防止DNS缓存投毒攻击
- 支持端口分离安全策略:
  - 注册端口(8080): 仅允许内网服务访问
  - 管理端口(9090): 仅允许管理网段访问
  - DNS端口(53): 根据需要开放给指定网段
  - 前端端口(3000): 仅允许管理员访问
- 支持API Token认证机制
- 支持IP白名单配置
- 支持基于角色的访问控制(RBAC)

### 3.5 兼容性需求 (NFR-005)
- 兼容Kong网关 2.x版本
- 支持标准DNS协议(RFC 1035)
- 支持Docker容器化部署
- 支持Kubernetes部署
- 兼容主流操作系统(Linux, macOS, Windows)

## 4. 技术约束

### 4.1 技术栈约束
- 后端开发语言: Go 1.21+
- 前端开发技术: React 18+ + TypeScript + Vite + Tailwind CSS
- 数据存储: etcd 3.5+
- 容器化: Docker
- 编排工具: Docker Compose / Kubernetes

### 4.2 架构约束
- 采用微服务架构设计
- 遵循RESTful API设计规范
- 使用接口解耦设计模式
- 支持分布式部署架构
- 遵循十二因子应用原则

### 4.3 开发约束
- 代码必须包含单元测试(覆盖率>80%)
- 必须提供完整的API文档
- 遵循Go代码规范和最佳实践
- 使用Git进行版本控制
- 采用CI/CD自动化部署

## 5. 接口规范

### 5.1 服务注册API (端口8080)
```
POST /api/v1/services
Content-Type: application/json

Request Body:
{
  "name": "service-name",
  "namespace": "production",  // 可选，默认为"default"
  "ip": "192.168.1.100",
  "port": 8080,
  "tags": ["api", "v1"],
  "metadata": {
    "version": "1.0.0",
    "environment": "production"
  },
  "ttl": "30s"
}

Response:
{
  "code": 200,
  "message": "success",
  "data": {
    "service_id": "service-uuid",
    "registered_at": "2024-01-01T00:00:00Z"
  }
}
```

### 5.2 服务注销API (端口8080)
```
DELETE /api/v1/services/{serviceId}

Response:
{
  "code": 200,
  "message": "service deregistered successfully"
}
```

### 5.3 心跳API (端口8080)
```
PUT /api/v1/services/{serviceId}/heartbeat

Response:
{
  "code": 200,
  "message": "heartbeat updated",
  "data": {
    "last_heartbeat": "2024-01-01T00:00:00Z"
  }
}
```

### 5.4 管理API (端口9090)
```
GET /api/v1/services                                # 查询服务列表
GET /api/v1/services?namespace=production          # 查询特定命名空间的服务列表
GET /api/v1/services/{serviceId}                    # 查询服务详情
GET /api/v1/namespaces                             # 查询命名空间列表
GET /api/v1/namespaces/{namespace}                 # 查询命名空间详情
POST /api/v1/namespaces                            # 创建命名空间
DELETE /api/v1/namespaces/{namespace}              # 删除命名空间
GET /api/v1/status                                  # 系统状态
GET /api/v1/health                                  # 健康检查
GET /api/v1/metrics                                 # 系统指标
GET /api/v1/dns/config                              # DNS配置管理
POST /api/v1/dns/custom-records                   # 创建自定义DNS记录
GET /api/v1/dns/custom-records                    # 查询自定义DNS记录列表
GET /api/v1/dns/custom-records/{recordId}           # 查询特定自定义DNS记录
PUT /api/v1/dns/custom-records/{recordId}           # 更新自定义DNS记录
DELETE /api/v1/dns/custom-records/{recordId}        # 删除自定义DNS记录

Response (服务列表示例):
{
  "code": 200,
  "message": "success",
  "data": {
    "services": [
      {
        "id": "service-uuid",
        "namespace": "production",
        "name": "service-name",
        "ip": "192.168.1.100",
        "port": 8080,
        "health": "healthy",
        "registered_at": "2024-01-01T00:00:00Z",
        "last_heartbeat": "2024-01-01T00:01:00Z"
      }
    ]
  }
}
```

## 6. 数据模型

### 6.1 服务实体
```go
type Service struct {
    ID            string            `json:"id"`
    Namespace     string            `json:"namespace"`
    Name          string            `json:"name"`
    IP            string            `json:"ip"`
    Port          int               `json:"port"`
    Tags          []string          `json:"tags"`
    Metadata      map[string]string `json:"metadata"`
    Health        HealthStatus      `json:"health"`
    RegisteredAt  time.Time         `json:"registered_at"`
    LastHeartbeat time.Time         `json:"last_heartbeat"`
    TTL           time.Duration     `json:"ttl"`
}
```

### 6.2 DNS记录实体
```go
type DNSRecord struct {
    ID         string `json:"id"`
    Namespace  string `json:"namespace"`
    Domain     string `json:"domain"`
    Type       string `json:"type"`     // A, AAAA, CNAME, SRV
    Value      string `json:"value"`
    TTL        uint32 `json:"ttl"`
    Priority   int    `json:"priority,omitempty"`
    Weight     int    `json:"weight,omitempty"`
}
```

### 6.3 命名空间实体
```go
type Namespace struct {
    Name        string    `json:"name"`
    Description string    `json:"description"`
    CreatedAt   time.Time `json:"created_at"`
    UpdatedAt   time.Time `json:"updated_at"`
    ServiceCount int      `json:"service_count"`
}
```

## 7. 部署要求

### 7.1 硬件要求
- **最小配置**: 2核CPU, 4GB内存, 20GB存储
- **推荐配置**: 4核CPU, 8GB内存, 50GB存储
- **生产环境**: 8核CPU, 16GB内存, 100GB存储

### 7.2 软件环境要求
- 操作系统: Linux (CentOS 7+, Ubuntu 18.04+)
- Docker: 20.0+
- etcd: 3.5+
- Go runtime: 1.21+ (开发环境)

### 7.3 网络要求
- DNS服务端口: 53 (UDP/TCP) - 对外提供DNS解析服务
- 服务注册端口: 8080 (TCP) - 供服务实例注册、注销、心跳使用
- 管理端口: 9090 (TCP) - 供管理界面和运维监控使用
- 前端界面端口: 3000 (TCP) - React管理界面
- etcd通信端口: 2379, 2380 (TCP)

### 7.4 防火墙配置建议
为确保系统安全，建议实施以下防火墙规则:

```
# 允许内网服务访问注册端口
iptables -A INPUT -p tcp -s 192.168.0.0/16 --dport 8080 -j ACCEPT
iptables -A INPUT -p tcp --dport 8080 -j DROP

# 允许管理网段访问管理端口
iptables -A INPUT -p tcp -s 10.0.0.0/8 --dport 9090 -j ACCEPT
iptables -A INPUT -p tcp --dport 9090 -j DROP

# 根据需要开放DNS端口给指定网段
iptables -A INPUT -p udp -s 192.168.0.0/16 --dport 53 -j ACCEPT
iptables -A INPUT -p tcp -s 192.168.0.0/16 --dport 53 -j ACCEPT

# 仅允许管理员访问前端界面
iptables -A INPUT -p tcp -s 10.0.0.0/8 --dport 3000 -j ACCEPT
iptables -A INPUT -p tcp --dport 3000 -j DROP
```

### 7.5 Docker部署配置
更新的Docker Compose配置示例:

```yaml
version: '3'
services:
  dns-discovery:
    image: kong-dns-discovery:latest
    ports:
      - "53:53/udp"  # DNS服务端口
      - "53:53/tcp"  # DNS TCP端口
      - "127.0.0.1:8080:8080"  # 服务注册端口，仅本地访问
      - "127.0.0.1:9090:9090"  # 管理端口，仅本地访问
    environment:
      - DNS_DOMAIN=service.local
      - ETCD_ENDPOINTS=etcd:2379
      - REGISTER_PORT=8080
      - ADMIN_PORT=9090
    networks:
      - kong-net
    depends_on:
      - etcd

  admin-ui:
    image: kong-dns-discovery-ui:latest
    ports:
      - "127.0.0.1:3000:3000"  # 前端界面端口，仅本地访问
    environment:
      - API_ENDPOINT=http://dns-discovery:9090
    networks:
      - kong-net
    depends_on:
      - dns-discovery

  etcd:
    image: bitnami/etcd:3.5
    ports:
      - "127.0.0.1:2379:2379"
    environment:
      - ALLOW_NONE_AUTHENTICATION=yes
    volumes:
      - etcd_data:/bitnami/etcd
    networks:
      - kong-net

volumes:
  etcd_data:

networks:
  kong-net:
    driver: bridge
```

## 8. 测试需求

### 8.1 功能测试
- [ ] 服务注册功能测试
- [ ] 服务注销功能测试
- [ ] DNS解析功能测试
- [ ] 心跳检测功能测试
- [ ] 管理界面功能测试
- [ ] 端口分离功能测试
- [ ] API安全访问测试
- [ ] 防火墙规则测试
- [ ] 查看服务自动生成DNS记录功能测试
- [ ] 自定义DNS记录增删改查功能测试

### 8.2 性能测试
- [ ] DNS查询性能测试
- [ ] API接口性能测试
- [ ] 并发压力测试
- [ ] 长时间稳定性测试
- [ ] 不同端口的性能隔离测试

### 8.3 集成测试
- [ ] Kong网关集成测试
- [ ] etcd集群集成测试
- [ ] 多实例部署测试
- [ ] **多副本部署下的故障切换和数据一致性测试**
- [ ] 故障恢复测试
- [ ] 端口分离环境下的集成测试
- [ ] 安全策略下的访问控制测试

### 8.4 安全测试
- [ ] 端口访问控制测试
- [ ] API认证授权测试
- [ ] 网络隔离测试
- [ ] 渗透测试
- [ ] HTTPS/TLS配置测试
- [ ] 防火墙规则验证

## 9. 文档需求

### 9.1 用户文档
- [ ] 系统安装部署指南
- [ ] 用户操作手册
- [ ] SDK使用指南
- [ ] API接口文档
- [ ] 故障排除指南

### 9.2 开发文档
- [ ] 系统设计文档
- [ ] 代码架构说明
- [ ] 数据库设计文档
- [ ] 接口设计文档
- [ ] 开发环境搭建指南

## 10. 验收标准

### 10.1 功能验收
- [ ] 所有功能需求实现完整
- [ ] API接口测试通过
- [ ] 管理界面功能正常
- [ ] SDK功能验证通过
- [ ] 集成测试通过
- [ ] 端口分离功能正常工作
- [ ] 能够查看服务自动生成的DNS记录
- [ ] 自定义DNS记录的增删改查功能正常

### 10.2 性能验收
- [ ] DNS查询性能达标
- [ ] API响应时间达标
- [ ] 并发处理能力达标
- [ ] 系统资源使用合理
- [ ] 各端口的服务器负载均衡

### 10.3 质量验收
- [ ] 代码质量检查通过
- [ ] 单元测试覆盖率达标
- [ ] 安全扫描无高危漏洞
- [ ] 文档完整性检查通过

### 10.4 安全验收
- [ ] 端口分离配置正确
- [ ] 防火墙规则正确配置
- [ ] API认证机制有效
- [ ] HTTPS/TLS配置安全
- [ ] 安全策略执行有效
- [ ] IP白名单限制有效
- [ ] RBAC权限控制有效

**### 10.5 可用性验收**
- **[ ] 系统在多副本部署模式下，单个或部分副本故障时服务依然可用**
- **[ ] 故障副本恢复后能自动加入集群并恢复服务**
- **[ ] 满足定义的故障恢复时间指标 (RTO)**
- **[ ] 数据备份和恢复流程验证通过**

## 11. 风险识别

### 11.1 技术风险
- **DNS协议实现复杂性**: 需要深入理解DNS协议规范
- **高并发性能优化**: DNS查询的高并发处理需要特殊优化
- **分布式一致性**: etcd集群的数据一致性保证

### 11.2 项目风险
- **Kong版本兼容性**: 不同Kong版本的兼容性适配
- **技术栈学习成本**: 团队对etcd和DNS协议的学习成本
- **部署复杂度**: 分布式系统的部署和运维复杂度

### 11.3 运营风险
- **服务稳定性**: 作为基础设施组件的稳定性要求
- **数据安全性**: 服务发现数据的安全保护
- **扩展性限制**: 大规模场景下的性能瓶颈

## 12. 项目计划

### 12.1 开发周期
- **总工期**: 12周
- **Phase 1**: 核心功能开发 (4周)
- **Phase 2**: 高级功能开发 (3周)  
- **Phase 3**: 完善和优化 (3周)
- **Phase 4**: 测试和部署 (2周)

### 12.2 里程碑
- **里程碑1**: 基础框架完成 (第2周)
- **里程碑2**: 核心功能完成 (第4周)
- **里程碑3**: 管理界面完成 (第7周)
- **里程碑4**: 系统集成完成 (第10周)
- **里程碑5**: 项目交付完成 (第12周)

### 12.3 资源需求
- **后端开发**: 2人
- **前端开发**: 1人
- **测试工程师**: 1人
- **运维工程师**: 0.5人

---

**文档版本**: 1.2  
**创建日期**: 2024-01-01  
**最后更新**: 2024-04-30  
**文档状态**: 待审核
