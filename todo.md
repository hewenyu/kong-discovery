# Kong网关DNS服务发现系统 - TODO

本文档规划了Kong网关DNS服务发现系统的开发任务列表，遵循任务最小化、顺序化原则，确保每个任务开发完成后进行测试，通过后再进行下一个任务。

## 阶段 0: 环境准备与基础架构

- [x] **T0.1**: 初始化项目仓库 (Git)
- [x] **T0.2**: 搭建基础Go项目结构 (服务注册API, 管理API, DNS服务模块骨架)
- [x] **T0.3**: 配置Docker环境及基础Dockerfile (Go服务)
- [x] **T0.4**: 配置Docker Compose用于本地etcd单节点启动
- [x] **T0.5**: 实现etcd客户端连接及基本操作封装 (CRUD)
    - *测试用例*: 能够连接etcd，并进行简单的键值读写测试。

## 阶段 1: 核心服务发现功能 (后端)

### 1.1 服务注册模块 (端口 8080)
- [x] **T1.1.1**: 实现服务注册API (`POST /api/v1/services`)
    - *功能*: 接收服务注册信息，存储到etcd (包括服务名, IP, 端口, 命名空间[默认default], TTL)。
    - *前置任务*: T0.5
    - *测试用例*: 
        - 成功注册一个服务实例，etcd中能查到对应记录，TTL设置正确。
        - 注册信息校验 (如缺少必要字段)。
        - 同一服务不同实例注册。
        - 不同命名空间注册同名服务。
- [x] **T1.1.2**: 实现服务心跳API (`PUT /api/v1/services/{serviceId}/heartbeat`)
    - *功能*: 更新etcd中服务实例的TTL。
    - *前置任务*: T1.1.1
    - *测试用例*: 
        - 对已注册服务发送心跳，etcd中TTL被刷新。
        - 对未注册服务ID发送心跳，返回错误。
- [x] **T1.1.3**: 实现服务注销API (`DELETE /api/v1/services/{serviceId}`)
    - *功能*: 从etcd中删除服务实例信息。
    - *前置任务*: T1.1.1
    - *测试用例*: 
        - 成功注销服务，etcd中记录被删除。
        - 注销不存在的服务ID。
- [x] **T1.1.4**: 实现服务健康检查与自动清理逻辑
    - *功能*: 后台协程定期扫描etcd，移除TTL过期的服务实例。
    - *前置任务*: T1.1.1
    - *测试用例*: 
        - 服务注册后不发心跳，在TTL过期后被自动清理。
        - 正常发送心跳的服务不被清理。

### 1.2 DNS服务模块 (端口 53)
- [x] **T1.2.1**: 实现基础DNS服务器骨架 (监听UDP/TCP 53端口)
    - *功能*: 能够接收DNS查询请求，并能够返回简单的硬编码响应。
    - *前置任务*: T0.2
    - *测试用例*: 使用`dig`或`nslookup`查询，能收到响应。
- [x] **T1.2.2**: 实现从etcd读取服务实例信息，支持A记录解析
    - *功能*: 根据DNS查询的服务名 (格式: `service.namespace.domain`) 从etcd查找健康服务实例，返回A记录。
    - *前置任务*: T1.1.1, T1.2.1
    - *测试用例*: 
        - `dig serviceA.default.service.local A` 能正确返回已注册服务`serviceA`的IP。
        - 查询不存在的服务或命名空间，返回NXDOMAIN。
        - 服务下线后，DNS解析不再返回其IP。
- [x] **T1.2.3**: 实现SRV记录解析
    - *功能*: 返回服务的IP、端口、权重、优先级。
    - *前置任务*: T1.2.2
    - *测试用例*: `dig serviceA.default.service.local SRV` 能返回正确IP和端口。
- [x] **T1.2.4**: 返回所有健康服务实例
    - *功能*: 对于有多个健康实例的服务，在DNS响应中返回所有健康实例。
    - *前置任务*: T1.2.2, T1.2.3
    - *测试用例*: 
        - 查询有多个实例的服务，能返回所有健康实例的A/SRV记录。
        - 查询同一IP不同端口的服务实例，能正确返回所有端口信息。
- [x] **T1.2.5**: 实现上游DNS转发功能
    - *功能*: 对于系统中未注册的域名，转发到配置的上游DNS服务器。
    - *前置任务*: T1.2.1
    - *测试用例*: 查询外部域名如`www.google.com`，能正确从上游DNS获取结果。
- [ ] **T1.2.6**: 实现DNS缓存 (简单内存缓存)
    - *功能*: 缓存DNS解析结果，减少对etcd的查询压力。
    - *前置任务*: T1.2.2
    - *测试用例*: 首次查询后，后续相同查询响应更快，etcd读取次数减少。

## 阶段 1.5: 核心功能测试用例

- [x] **T1.5.1**: 服务存储层单元测试
    - *功能*: 为`internal/store/service`包编写完整的单元测试。
    - *前置任务*: T1.1.4
    - *测试用例*:
        - 服务注册与获取测试
        - 多服务实例注册测试
        - 心跳更新测试
        - 服务注销测试
        - 过期服务清理测试
- [x] **T1.5.2**: 服务注册API集成测试
    - *功能*: 为服务注册API编写集成测试。
    - *前置任务*: T1.1.3
    - *测试用例*: 
        - API注册、心跳、注销流程测试
        - 错误处理测试
        - 并发注册测试
- [x] **T1.5.3**: DNS服务集成测试
    - *功能*: 为DNS服务编写集成测试。
    - *前置任务*: T1.2.6
    - *测试用例*:
        - DNS查询解析测试
        - 返回所有服务实例测试
        - 缓存效果测试
        - 上游转发测试

## 阶段 2: 管理功能 (后端API & 前端基础)

### 2.1 管理API服务 (端口 9090)
- [x] **T2.1.1**: 实现查询服务列表API (`GET /api/v1/services`, `GET /api/v1/services?namespace=...`)
    - *功能*: 从etcd读取服务列表，支持按命名空间过滤。
    - *前置任务*: T1.1.1
    - *测试用例*: 能正确返回所有服务或特定命名空间的服务，信息完整。
- [x] **T2.1.2**: 实现查询服务详情API (`GET /api/v1/services/{serviceId}`)
    - *功能*: 从etcd读取特定服务实例的详细信息。
    - *前置任务*: T1.1.1
    - *测试用例*: 能正确返回指定服务的详情。
- [ ] **T2.1.3**: 实现命名空间管理API (CRUD)
    - `POST /api/v1/namespaces`
    - `GET /api/v1/namespaces`
    - `GET /api/v1/namespaces/{namespace}`
    - `DELETE /api/v1/namespaces/{namespace}`
    - *功能*: 在etcd中管理命名空间定义。
    - *前置任务*: T0.5
    - *测试用例*: 命名空间的创建、查询、删除操作符合预期。
- [ ] **T2.1.4**: 实现自定义DNS记录管理API (CRUD)
    - `POST /api/v1/dns/custom-records`
    - `GET /api/v1/dns/custom-records`
    - `GET /api/v1/dns/custom-records/{recordId}`
    - `PUT /api/v1/dns/custom-records/{recordId}`
    - `DELETE /api/v1/dns/custom-records/{recordId}`
    - *功能*: 在etcd中管理自定义DNS记录 (A, AAAA, CNAME, SRV)。
    - *前置任务*: T0.5
    - *测试用例*: 自定义DNS记录的增删改查，DNS服务模块能正确解析这些记录 (T1.2.2需相应修改以优先查询自定义记录)。
- [ ] **T2.1.5**: 实现系统状态/健康检查/指标API (初步)
    - `GET /api/v1/status`, `GET /api/v1/health`, `GET /api/v1/metrics` (暴露基本信息和etcd连接状态)。
    - *前置任务*: T0.5
    - *测试用例*: API返回正确的系统状态信息。
- [ ] **T2.1.6**: 实现DNS配置管理API (`GET /api/v1/dns/config`, `POST /api/v1/dns/config` - 初步，如上游DNS服务器)
    - *功能*: 管理DNS服务的配置，如上游DNS，存储于etcd。
    - *前置任务*: T0.5, T1.2.5 (上游DNS配置需从此API读取)
    - *测试用例*: 配置上游DNS后，DNS服务模块能使用新的上游。

### 2.2 前端管理界面 (Admin UI - 基础搭建)
- [ ] **T2.2.1**: 初始化React项目 (Vite, TypeScript, Tailwind CSS)
- [ ] **T2.2.2**: 搭建基本布局和路由结构。
- [ ] **T2.2.3**: 实现与管理API的连接 (不含认证)
    - *前置任务*: T2.1.1 (至少有一个API可供连接测试)

## 阶段 3: SDK 开发

- [ ] **T3.1**: 开发Go SDK
    - *功能*: 封装服务注册、注销、心跳接口调用。
    - *前置任务*: T1.1.1, T1.1.2, T1.1.3
    - *测试用例*: 提供示例Go服务，使用SDK完成注册、心跳、注销流程。
- [ ] **T3.2**: 开发React SDK (UI组件库 - 初步)
    - *功能*: 封装调用管理API的hooks或服务，提供基础组件 (如ServiceList)。
    - *前置任务*: T2.1.1, T2.2.3
    - *测试用例*: 在Admin UI中使用SDK组件展示服务列表。

## 阶段 4: 前端管理界面完善

- [ ] **T4.1**: 实现服务监控页面 (服务列表、详情、状态、关联DNS记录查看)
    - *前置任务*: T2.1.1, T2.1.2, T3.2, (T1.2.2/T1.2.3 - DNS记录逻辑)
    - *测试用例*: 界面能正确显示服务信息，实时更新（轮询或WebSocket待定）。
- [ ] **T4.2**: 实现命名空间管理页面 (CRUD)
    - *前置任务*: T2.1.3, T3.2
    - *测试用例*: 界面能进行命名空间的增删改查。
- [ ] **T4.3**: 实现自定义DNS记录管理页面 (CRUD)
    - *前置任务*: T2.1.4, T3.2
    - *测试用例*: 界面能进行自定义DNS记录的增删改查。
- [ ] **T4.4**: 实现系统配置管理页面 (如DNS配置)
    - *前置任务*: T2.1.6, T3.2
    - *测试用例*: 界面能修改并保存DNS配置。
- [ ] **T4.5**: 实现系统状态/监控概览页面
    - *前置任务*: T2.1.5, T3.2
    - *测试用例*: 展示基本的系统运行状态和统计信息。

## 阶段 5: 非功能性需求与强化

- [ ] **T5.1 (未来规划)**: ~~API Token认证机制实现与集成~~
    - ~~*功能*: 为8080和9090端口的API增加Token认证。~~
    - ~~*前置任务*: T1.1.1, T2.1.1~~
    - ~~*测试用例*: 无Token或无效Token访问API被拒绝，有效Token访问成功。~~
- [ ] **T5.2**: 实现HTTPS/TLS支持 (各服务端口)
- [ ] **T5.3**: 完善多副本部署配置 (Docker Compose, Kubernetes manifests初步)
- [ ] **T5.4**: 性能测试与优化 (DNS查询QPS, API RPS)
- [ ] **T5.5**: 安全性加固 (输入验证、错误处理、依赖扫描)
- [ ] **T5.6**: 编写详细的单元测试和集成测试。

## 阶段 6: 文档与交付

- [ ] **T6.1**: 完善所有用户文档和开发文档。
- [ ] **T6.2**: 完成所有验收标准的测试用例。
- [ ] **T6.3**: 准备最终交付包。

---
**注意**: 
- 每个任务完成后，应编写并执行相应的单元测试和集成测试。
- 标记为 `*测试用例*:` 的是该任务完成后需要验证的关键点。
- 任务的粒度可以根据实际情况调整，但需保证前置依赖的清晰。 